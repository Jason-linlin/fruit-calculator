<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>水果進貨管理</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { padding: 10px; font-family: Arial, sans-serif; }
    input, select, button { font-size: 1.1em; padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 6px; }
    table { margin-top: 20px; width: 100%; font-size: 0.95em; }
    button { cursor: pointer; }
    .delete-btn { background-color: #ff5c5c; color: white; border: none; }
    .edit-btn { background-color: #4CAF50; color: white; border: none; }
    @media (min-width: 600px) { input, select, button { width: auto; } }
  </style>
</head>
<body>
  <h2>水果進貨管理</h2>
  <div id="currentTime" style="font-weight: bold;">現在時間：--:--:--</div><br>

  <label>品名：</label>
  <input type="text" id="fruitName" placeholder="輸入品名">
  <select id="fruitSelect" onchange="selectFruit()" style="margin-top:5px;"></select>
  <button onclick="deleteFruitOption()">刪除選擇的品名</button><br><br>

  <label>貨主：</label>
  <input type="text" id="owner" placeholder="輸入貨主">

  <label>Size：</label>
  <input type="text" id="size" placeholder="輸入Size">

  <label>單價：</label>
  <input type="number" inputmode="numeric" id="price" placeholder="輸入單價" />

  <label>進貨數量：</label>
  <input type="number" inputmode="numeric" id="quantity" placeholder="輸入進貨數量" />

  <button onclick="addEntry()">新增進貨資料</button>
  <button onclick="exportToExcel()">匯出 Excel 並清空</button>
  <button onclick="clearAll()">全部清空</button><br><br>

  <div id="fruitResult">今天進貨總數量：<span id="totalQuantity">0</span></div>

  <table id="fruitTable">
    <thead>
      <tr>
        <th>品名</th>
        <th>貨主</th>
        <th>Size</th>
        <th>單價</th>
        <th>進貨數量</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const STORAGE_KEY = 'fruitData';
    const FRUIT_OPTIONS_KEY = 'fruitOptions';

    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').innerText = '現在時間：' + now.toLocaleString();
    }
    setInterval(updateTime, 1000);
    updateTime();

    function addEntry() {
      const select = document.getElementById('fruitSelect');
      const selectedFruit = select.value;
      const inputFruit = document.getElementById('fruitName').value.trim();
      const name = selectedFruit ? selectedFruit : inputFruit;

      const owner = document.getElementById('owner').value.trim();
      const size = document.getElementById('size').value.trim();
      const price = document.getElementById('price').value.trim();
      const quantity = parseInt(document.getElementById('quantity').value.trim());

      if (!name || !owner || !size || isNaN(price) || isNaN(quantity)) {
        alert('請完整輸入所有資訊');
        return;
      }

      const data = { name, owner, size, price, quantity };
      addRow(data);
      saveToLocalStorage();
      addFruitOption(name);

      document.getElementById('fruitName').value = '';
      document.getElementById('owner').value = '';
      document.getElementById('size').value = '';
      document.getElementById('price').value = '';
      document.getElementById('quantity').value = '';
      document.getElementById('fruitSelect').selectedIndex = 0;
    }

    function addRow(data) {
      const tableBody = document.querySelector('#fruitTable tbody');
      const newRow = tableBody.insertRow();
      newRow.insertCell(0).innerText = data.name;
      newRow.insertCell(1).innerText = data.owner;
      newRow.insertCell(2).innerText = data.size;
      newRow.insertCell(3).innerText = data.price;
      newRow.insertCell(4).innerText = data.quantity;

      const controlCell = newRow.insertCell(5);
      const editBtn = document.createElement('button');
      editBtn.innerText = '編輯';
      editBtn.className = 'edit-btn';
      editBtn.onclick = function () { enableEdit(newRow, editBtn); };

      const deleteBtn = document.createElement('button');
      deleteBtn.innerText = '刪除';
      deleteBtn.className = 'delete-btn';
      deleteBtn.onclick = function () {
        tableBody.removeChild(newRow);
        saveToLocalStorage();
        updateTotalQuantity();
      };

      controlCell.appendChild(editBtn);
      controlCell.appendChild(deleteBtn);
      updateTotalQuantity();
    }

    function enableEdit(row, editBtn) {
      for (let i = 0; i <= 4; i++) {
        row.cells[i].innerHTML = `<input type="text" value="${row.cells[i].innerText}">`;
      }
      editBtn.innerText = '儲存';
      editBtn.onclick = function () { saveEdit(row, editBtn); };
    }

    function saveEdit(row, editBtn) {
      for (let i = 0; i <= 4; i++) {
        row.cells[i].innerText = row.cells[i].querySelector('input').value;
      }
      editBtn.innerText = '編輯';
      editBtn.onclick = function () { enableEdit(row, editBtn); };
      updateTotalQuantity();
      saveToLocalStorage();
    }

    function updateTotalQuantity() {
      const rows = document.querySelectorAll('#fruitTable tbody tr');
      let total = 0;
      rows.forEach(row => {
        const qty = parseInt(row.cells[4].innerText);
        total += isNaN(qty) ? 0 : qty;
      });
      document.getElementById('totalQuantity').innerText = total;
    }

    function saveToLocalStorage() {
      const rows = document.querySelectorAll('#fruitTable tbody tr');
      const data = Array.from(rows).map(row => ({
        name: row.cells[0].innerText,
        owner: row.cells[1].innerText,
        size: row.cells[2].innerText,
        price: row.cells[3].innerText,
        quantity: row.cells[4].innerText
      }));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return;
      JSON.parse(saved).forEach(data => addRow(data));
    }

    function clearAll() {
      document.querySelector('#fruitTable tbody').innerHTML = '';
      updateTotalQuantity();
      localStorage.removeItem(STORAGE_KEY);
    }

    function exportToExcel() {
      const now = new Date();
      const fileNameTime = now.toISOString().replace(/[:.]/g, '-');
      const wb = XLSX.utils.book_new();
      const ws_data = [['品名', '貨主', 'Size', '單價', '進貨數量']];
      const rows = document.querySelectorAll('#fruitTable tbody tr');
      rows.forEach(row => {
        const name = row.cells[0].innerText;
        const owner = row.cells[1].innerText;
        const size = row.cells[2].innerText;
        const price = row.cells[3].innerText;
        const quantity = row.cells[4].innerText;
        ws_data.push([name, owner, size, price, quantity]);
      });
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, '進貨清單');
      XLSX.writeFile(wb, `進貨記錄_${fileNameTime}.xlsx`);
      clearAll();
    }

    function addFruitOption(name) {
      const select = document.getElementById('fruitSelect');
      const options = Array.from(select.options).map(opt => opt.value);
      if (!options.includes(name)) {
        const option = document.createElement('option');
        option.value = name;
        option.text = name;
        select.appendChild(option);
        saveFruitOptions();
      }
    }

    function selectFruit() {
      const selected = document.getElementById('fruitSelect').value;
      if (selected) {
        document.getElementById('fruitName').value = '';
      }
    }

    function deleteFruitOption() {
      const select = document.getElementById('fruitSelect');
      if (select.selectedIndex !== -1) {
        select.remove(select.selectedIndex);
        saveFruitOptions();
      }
    }

    function saveFruitOptions() {
      const select = document.getElementById('fruitSelect');
      const fruits = Array.from(select.options).map(opt => opt.value);
      localStorage.setItem('fruitOptions', JSON.stringify(fruits));
    }

    function loadFruitOptions() {
      const saved = localStorage.getItem('fruitOptions');
      if (!saved) return;
      const fruits = JSON.parse(saved);
      const select = document.getElementById('fruitSelect');
      fruits.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.text = name;
        select.appendChild(option);
      });
    }

    loadFromLocalStorage();
    loadFruitOptions();
  </script>
</body>
</html>